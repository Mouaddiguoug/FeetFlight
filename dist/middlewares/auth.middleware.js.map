{"version":3,"sources":["../../src/middlewares/auth.middleware.ts"],"sourcesContent":["import { NextFunction, Response } from 'express';\nimport { verify } from 'jsonwebtoken';\nimport { SECRET_KEY } from '@config';\nimport { HttpException } from '@exceptions/HttpException';\nimport { DataStoredInToken, RequestWithUser } from '@interfaces/auth.interface';\nimport { initializeDbConnection } from '@/app';\n\nconst authMiddleware = async (req: RequestWithUser, res: Response, next: NextFunction) => {\n  const Authorization = req.cookies['Authorization'] || (req.header('Authorization') ? req.header('Authorization').split('Bearer ')[1] : null);\n  const authMiddlewareSession = initializeDbConnection().session();\n  if (Authorization) {\n    try {\n      const secretKey: string = SECRET_KEY;\n      const verificationResponse = (verify(Authorization, secretKey)) as DataStoredInToken;\n\n      const userId = verificationResponse.id;\n      console.log(verificationResponse);\n\n      const foundUser = await authMiddlewareSession.executeRead(tx => tx.run('match (u:user {id: $userId}) return u', {\n        userId: userId\n      }));\n\n      if (foundUser.records.length > 0) {\n        next();\n      } else {\n        next(new HttpException(400, 'Wrong authentication token'));\n      }\n    } catch (error) {\n      console.log(error);\n      next(new HttpException(401, 'missing token'));\n    }\n  } else {\n    next(new HttpException(400, 'Authentication token missing'));\n  }\n};\n\nexport default authMiddleware;\n"],"names":["authMiddleware","req","res","next","Authorization","cookies","header","split","authMiddlewareSession","initializeDbConnection","session","secretKey","SECRET_KEY","verificationResponse","verify","userId","id","console","log","foundUser","executeRead","tx","run","records","length","HttpException","error"],"mappings":";;;;+BAoCA;;;eAAA;;;8BAnCuB;wBACI;+BACG;qBAES;AAEvC,MAAMA,iBAAiB,OAAOC,KAAsBC,KAAeC;IACjE,MAAMC,gBAAgBH,IAAII,OAAO,CAAC,gBAAgB,IAAKJ,CAAAA,IAAIK,MAAM,CAAC,mBAAmBL,IAAIK,MAAM,CAAC,iBAAiBC,KAAK,CAAC,UAAU,CAAC,EAAE,GAAG,IAAG;IAC1I,MAAMC,wBAAwBC,IAAAA,2BAAsB,IAAGC,OAAO;IAC9D,IAAIN,eAAe;QACjB,IAAI;YACF,MAAMO,YAAoBC,kBAAU;YACpC,MAAMC,uBAAwBC,IAAAA,oBAAM,EAACV,eAAeO;YAEpD,MAAMI,SAASF,qBAAqBG,EAAE;YACtCC,QAAQC,GAAG,CAACL;YAEZ,MAAMM,YAAY,MAAMX,sBAAsBY,WAAW,CAACC,CAAAA,KAAMA,GAAGC,GAAG,CAAC,yCAAyC;oBAC9GP,QAAQA;gBACV;YAEA,IAAII,UAAUI,OAAO,CAACC,MAAM,GAAG,GAAG;gBAChCrB;YACF,OAAO;gBACLA,KAAK,IAAIsB,4BAAa,CAAC,KAAK;YAC9B;QACF,EAAE,OAAOC,OAAO;YACdT,QAAQC,GAAG,CAACQ;YACZvB,KAAK,IAAIsB,4BAAa,CAAC,KAAK;QAC9B;IACF,OAAO;QACLtB,KAAK,IAAIsB,4BAAa,CAAC,KAAK;IAC9B;AACF;MAEA,WAAezB"}